import React, { useState } from 'react';
import Layout from './components/Layout';
import Flashcard from './components/Flashcard';
import curriculumData from './data/curriculum/level-1-basics.json';
import { useAudio } from './hooks/useAudio';

const SESSION_LENGTH = 10;

function App() {
  const [sessionData, setSessionData] = useState(() => {
    // Shuffle and pick 10 cards for this session
    const shuffled = [...curriculumData].sort(() => 0.5 - Math.random());
    return shuffled.slice(0, SESSION_LENGTH);
  });
  
  const [currentIndex, setCurrentIndex] = useState(0);
  const [isFlipped, setIsFlipped] = useState(false);
  const [stats, setStats] = useState({ correct: 0, incorrect: 0 });
  const [sessionComplete, setSessionComplete] = useState(false);
  
  const { playCorrect, playIncorrect } = useAudio();

  // Derive current card
  const currentCard = sessionData[currentIndex];
  // Calculate Progress
  const progress = ((currentIndex) / sessionData.length) * 100;

  const handleRate = (result) => {
    // 1. Play Sound
    if (result === 'correct') {
      playCorrect();
    } else {
      playIncorrect();
    }

    // 2. Update Stats
    setStats(prev => ({
      ...prev,
      [result]: prev[result] + 1
    }));

    // 3. Move to next card or finish
    if (currentIndex < sessionData.length - 1) {
      setIsFlipped(false);
      setTimeout(() => setCurrentIndex(prev => prev + 1), 300); // Small delay for UX
    } else {
      setSessionComplete(true);
    }
  };

  const startNewSession = () => {
    const shuffled = [...curriculumData].sort(() => 0.5 - Math.random());
    setSessionData(shuffled.slice(0, SESSION_LENGTH));
    setCurrentIndex(0);
    setIsFlipped(false);
    setStats({ correct: 0, incorrect: 0 });
    setSessionComplete(false);
  };

  if (sessionComplete) {
    return (
      <Layout>
        <div style={{
          display: 'flex', 
          flexDirection: 'column', 
          alignItems: 'center', 
          justifyContent: 'center', 
          height: '100%',
          textAlign: 'center',
          gap: 'var(--spacing-6)'
        }}>
          <h2 style={{ fontSize: 'var(--font-size-2xl)', color: 'var(--color-primary)' }}>Session Complete! ðŸŽ‰</h2>
          
          <div style={{ 
            background: 'white', 
            padding: 'var(--spacing-8)', 
            borderRadius: 'var(--radius-lg)',
            boxShadow: 'var(--shadow-card)',
            width: '100%',
            maxWidth: '400px'
          }}>
            <div style={{ display: 'flex', justifyContent: 'space-around', marginBottom: 'var(--spacing-4)' }}>
              <div>
                <p style={{ color: 'var(--color-success)', fontSize: '2rem', fontWeight: 'bold' }}>{stats.correct}</p>
                <p>Easy</p>
              </div>
              <div>
                <p style={{ color: 'var(--color-error)', fontSize: '2rem', fontWeight: 'bold' }}>{stats.incorrect}</p>
                <p>Hard</p>
              </div>
            </div>
            <p style={{ color: 'var(--color-text-light)' }}>Great job practicing!</p>
          </div>

          <button 
            onClick={startNewSession}
            style={{
              background: 'var(--color-primary)',
              color: 'white',
              border: 'none',
              padding: 'var(--spacing-4) var(--spacing-8)',
              borderRadius: 'var(--radius-full)',
              fontSize: 'var(--font-size-lg)',
              fontWeight: 'bold',
              cursor: 'pointer',
              boxShadow: '0 4px 0 var(--color-primary-dark)',
            }}
          >
            Start New Session âžœ
          </button>
        </div>
      </Layout>
    );
  }

  return (
    <Layout>
      <div style={{
        display: 'flex',
        flexDirection: 'column',
        gap: 'var(--spacing-6)',
        height: '100%',
        justifyContent: 'center',
        padding: '0 var(--spacing-4)'
      }}>
        
        {/* Header / Progress */}
        <div style={{ display: 'flex', flexDirection: 'column', gap: 'var(--spacing-2)' }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', color: 'var(--color-text-light)' }}>
            <span>Level 1: The Basics</span>
            <span>{currentIndex + 1} / {sessionData.length}</span>
          </div>
          <div style={{ 
            height: '8px', 
            background: '#E0E0E0', 
            borderRadius: 'var(--radius-full)',
            overflow: 'hidden' 
          }}>
            <div style={{ 
              width: `${progress}%`, 
              height: '100%', 
              background: 'var(--color-primary)',
              transition: 'width 0.3s ease'
            }} />
          </div>
        </div>

        {/* Flashcard Area */}
        <Flashcard 
          key={currentCard.id || currentIndex} // Force re-render on new card
          cardData={currentCard} 
          isFlipped={isFlipped} 
          onFlip={() => setIsFlipped(true)}
        />

        {/* Controls - Only show when flipped */}
        <div style={{ 
          height: '80px', 
          display: 'flex', 
          justifyContent: 'center', 
          gap: 'var(--spacing-4)',
          opacity: isFlipped ? 1 : 0,
          pointerEvents: isFlipped ? 'auto' : 'none',
          transition: 'opacity 0.3s'
        }}>
          <button 
            onClick={() => handleRate('incorrect')}
            style={{
              flex: 1,
              background: 'white',
              border: '2px solid var(--color-error)',
              color: 'var(--color-error)',
              borderRadius: 'var(--radius-lg)',
              fontWeight: 'bold',
              fontSize: 'var(--font-size-lg)',
              boxShadow: '0 4px 0 #ffcdd2'
            }}
          >
            Hard ðŸ˜“
          </button>
          
          <button 
            onClick={() => handleRate('correct')}
            style={{
              flex: 1,
              background: 'var(--color-success)',
              border: 'none',
              color: 'white',
              borderRadius: 'var(--radius-lg)',
              fontWeight: 'bold',
              fontSize: 'var(--font-size-lg)',
              boxShadow: '0 4px 0 var(--color-accent-dark)'
            }}
          >
            Easy! ðŸ¤©
          </button>
        </div>

      </div>
    </Layout>
  );
}

export default App;
